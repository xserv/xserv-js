<!DOCTYPE html>
<html>
  <head>
    <title>Xserv JS SDK - Basic WebRTC Integration Example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://mobile-italia.com/xserv/xserv.min.js"></script>
    <link rel="stylesheet" type="text/css" href="custom.css">
  </head>
  
  <body class="margintop">
    <h1>Xserv JS SDK - Basic WebRTC Integration Example</h1>
    <p>This example use a basic Xserv WebRTC integration. Share this page with your friends to test.</p>
    <br>
    <div id="video_div"></div>
    
    <div class="box">
      <span>
	<svg xmlns="https://www.w3.org/2000/svg" width="20px" height="20px">
	  <circle id="state" cx="10" cy="10" r="10" fill="red" />
	</svg>
      </span>
      <span class="label">Connection Status</span>
      <span id="info">{}</span>
    </div>
    
    <div class="panel">
      <input type="text" id="topic" placeholder="Topic"> 
      <button id="subscribe">Subscribe</button>
      <button id="unsubscribe">Unsubscribe</button>
    </div>
    
    <div class="panel">
      <input type="text" id="message" placeholder="Message">
      <button id="publish">Publish</button>
    </div>
    
    <pre id="output2"></pre>
    
    <script>
      $(document).ready(function() {

        var app_id = "9Pf80-3";
        var xserv = new Xserv(app_id);
        // xserv.setReconnectInterval(20000);

        xserv.addEventListener("connection_open", function() {
           $("#state").attr("fill", "green");
           $("#info").text(JSON.stringify(xserv.getUserData()));
        });

        xserv.addEventListener("connection_close", function(event) {
           $("#state").attr("fill", "red");
        });

        xserv.addEventListener("connection_error", function(event) {
           $("#state").attr("fill", "yellow");
        });

        xserv.addEventListener("messages", function(json) {
            var prefix = json.socket_id == xserv.getSocketId() ? "You: " : xserv.getSocketId() + ": "
            var html = "<div class='row'>" + prefix + json.data + "</div>";
            $(html).hide().prependTo("#output2").fadeIn(1000);
        });

        xserv.addEventListener("operations", function(json) {
            if (json.op == Xserv.OP_SUBSCRIBE && json.rc == Xserv.RC_OK) {
            	$("#info").text(JSON.stringify(xserv.getUserData())); // more data
                
            	xserv.createExtra("webrtc", json.topic, "video_div");
            } else if (json.op == Xserv.OP_UNSUBSCRIBE && json.rc == Xserv.RC_OK) {
            	$("#rtc").html('');
            }
        });

        $("#subscribe").click(function() {
           xserv.subscribe($("#topic").val());
        });

        $("#unsubscribe").click(function() {
           xserv.unsubscribe($("#topic").val());
        });

        $("#publish").click(function() {
           var data = $("#message").val();
           if (Xserv.Utils.isString(data)) {
             try {
               data = JSON.parse(data);
             } catch(e) {
             }
           }
           xserv.publish($("#topic").val(), data);
           $("#message").val("");
           $("#message").focus();
        });

        $("#message").keyup(function(event){
           if (event.keyCode == 13){
              $("#publish").click();
           }
        });

        xserv.connect();

      });
    </script>
  </body>
</html>
