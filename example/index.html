<!DOCTYPE html>
<html>
  <head>
    <title>HTML5 Demo</title>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="../xserv.js"></script>
    <link rel="stylesheet" type="text/css" href="custom.css">
  </head>
  
  <body>
    
    <div class="box">
      <span>
	<svg xmlns="https://www.w3.org/2000/svg" width="20px" height="20px">
	  <circle id="state" cx="10" cy="10" r="10" fill="red" />
	</svg>
      </span>
      <span>Connection status</span>
      <span>&nbsp;&nbsp;&nbsp;&nbsp;</span> 
      <span id="info">{}</span>
    </div>
    
    <p><button id="connect">Connect</button> <button id="disconnect">Disconnect</button> <button id="clear">Clear</button></p>
    
    <p><input type="text" id="topic" placeholder="Topic"> <input type="text" id="user" placeholder="User (private)"> <input type="text" id="pass" placeholder="Pass (private)"> 
      <button id="subscribe">Subscribe</button> <button id="private">Subscribe Private</button> <button id="unsubscribe">Unsubscribe</button> 
      <button id="presence">Presence</button> <button id="topics">Topics</button></p>
    
    <p><input type="text" id="message" placeholder="Message"> <button id="publish">Publish</button></p>
    
    <p><input type="text" id="offset" placeholder="Offset"> <input type="text" id="limit" placeholder="Limit"> 
      <button id="history_i">History by ID</button> <button id="history_t">History by Timestamp</button></p>
    
    <p>Ops response</p>
    <pre id="output_op"></pre>
    <p>Messages</p>
    <pre id="output"></pre>
    
    <script>
      $(document).ready(function() {
        $("#connect").click(function() {
           xserv.connect();
        });
        $("#disconnect").click(function() {
           xserv.disconnect();
        });
        $("#clear").click(function() {
           $("#output_op").html("");
           $("#output").html("");
        });
        
        $("#publish").click(function() {
           xserv.publish($("#topic").val(), $("#message").val());
        });
        $("#subscribe").click(function() {
           xserv.subscribe($("#topic").val());
        });
        $("#unsubscribe").click(function() {
           xserv.unsubscribe($("#topic").val());
        });
        $("#private").click(function() {
           // private
           xserv.subscribe($("#topic").val(), {
               params: {
                   user:$("#user").val(), 
                   pass:$("#pass").val()
               }
           });
        });
        $("#presence").click(function() {
           xserv.presence($("#topic").val());
        });
        $("#topics").click(function() {
           xserv.topics();
        });
        $("#history_i").click(function() {
           xserv.historyById($("#topic").val(), $("#offset").val(), $("#limit").val());
        });
        $("#history_t").click(function() {
           xserv.historyByTimestamp($("#topic").val(), $("#offset").val(), $("#limit").val());
        });
        
        var xserv = new Xserv("9Pf80-3");
	// xserv.setReconnectInterval(20000);
	
        xserv.addEventListener("open_connection", function() {
           $("#state").attr("fill", "green");
           $("#info").text(JSON.stringify(xserv.getUserData()));
	});
	
	xserv.addEventListener("close_connection", function(event) {
            // console.log(event);
	    $("#state").attr("fill", "red");
	});
        
        xserv.addEventListener("error_connection", function(event) {
            // console.log(event);
	    $("#state").attr("fill", "yellow");
	});
        
	xserv.addEventListener("receive_messages", function(json) {
            var html = "<div class='row'>" + JSON.stringify(json) + "</div>";
            $(html).hide().prependTo("#output").fadeIn(1000);
            // alert(json.message);
        });
        
        xserv.addEventListener("receive_ops_response", function(json) {
            var html = "<div class='row'>" + JSON.stringify(json) + "</div>";
	    $(html).hide().prependTo("#output_op").fadeIn(1000);
            
            if (json.op == Xserv.OP_SUBSCRIBE && json.rc == Xserv.RC_OK && Xserv.isPrivateTopic(json.topic)) {
               $("#info").text(JSON.stringify(xserv.getUserData())); // more data
            }
            // alert(json.data);
	});
        
        xserv.connect();
      });
    </script>
    
  </body>
</html>
