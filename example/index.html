<!DOCTYPE html>
<html>
  <head>
    <title>HTML5 Demo</title>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="..//xserv.js"></script>
    <link rel="stylesheet" type="text/css" href="core.css">
  </head>
  
  <body>
    <input type="text" id="user"> <input type="text" id="pass"> <button id="private">Bind private channel</button>
    <pre id="info"></pre>
    <button id="presence">Presence</button>
    <div class="box">
      <span>Connection status</span>
      <span>
	<svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px">
	  <circle id="state" cx="10" cy="10" r="10" fill="red" />
	</svg>
      </span>
    </div>
    <pre id="output"></pre>
  </body>
  <script>
    $(document).ready(function() {
        $("#private").click(function() {
           xserv.bind('@milano', 'all', {endpoint:'http://localhost:4321/auth_user', user:$("#user").val(), pass:$("#pass").val()});
           xserv.bind('@milano', 'metro', {endpoint:'http://localhost:4321/auth_user', user:$("#user").val(), pass:$("#pass").val()});
        });
        
        $("#presence").click(function() {
           // xserv.presence('@milano', 'metro');
           xserv.presence('@milano');
        });
        
	var xserv = new Xserv('qLxFC-1'); // app_id
	// xserv.setReconnectInterval(20000);
	
	xserv.addEventListener('open', function() {
           $('#state').attr('fill', 'green');
           // xserv.historyById('test', 'all', 1);
	});
	
	xserv.addEventListener('close', function() {
	    $('#state').attr('fill', 'red');
	});
	
	xserv.addEventListener('events', function(data) {
            var html = "<div id='blah' class='row'>EVENTS " + JSON.stringify(data) + "</div>";
            $(html).hide().appendTo('#output').fadeIn(1000);
        });
        
        xserv.addEventListener('events:op', function(data) {
            var html = "<div id='blah' class='row'>OP " + JSON.stringify(data) + "</div>";
	    $(html).hide().appendTo('#output').fadeIn(1000);
            
            if (data.op == Xserv.BIND && data.rc == Xserv.RC_DONE && data.topic.charAt(0) == '@' && xserv.user_data) {
                $("#info").text(xserv.user_data.name || xserv.user_data);
            }
	});
        
        xserv.bind('milano', 'all');
        // xserv.bind('test', 'all');
        // xserv.bind('test', 'pippo');
        // xserv.unbind('test');
        // xserv.unbind('test', 'pippo');
        // xserv.unbind('test', 'pippo');
        xserv.historyById('test', 'all', 18, 5);
        // xserv.historyById('test', 'all', 1, 2000);
        // xserv.historyById('test', 'pippo', 1); // default limit 100
        // xserv.presence('milano', 'all');
        
        if (!xserv.isConnected()) {
           xserv.connect();
        }
    });
  </script>
</html>
