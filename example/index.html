<!DOCTYPE html>
<html>
  <head>
    <title>Xserv JS SDK - WebSocket API Example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="../xserv.js"></script>
    <link rel="stylesheet" type="text/css" href="custom.css">
  </head>
  
  <body>
    <h1>Xserv JS SDK - WebSocket API Example</h1>
    <p>This example allows to use all Xserv WebSocket API commands.<br>For private topic try to use '@milano' user:'amatig' pass:'amatig' or user:'nughy' pass:'nughy'.</p>
    <br>
    <div class="box">
      <span>
	<svg xmlns="https://www.w3.org/2000/svg" width="20px" height="20px">
	  <circle id="state" cx="10" cy="10" r="10" fill="red" />
	</svg>
      </span>
      <span class="label">Connection Status</span>
      <span id="info">{}</span>
    </div>
    
    <div class="panel">
      <button id="connect">Connect</button>
      <button id="disconnect">Disconnect</button>
      <button id="clear">Clear</button>
    </div>
    
    <div class="panel">
      <input type="text" id="topic" placeholder="Topic">
      <input type="text" id="user" placeholder="User (private)">
      <input type="text" id="pass" placeholder="Pass (private)"> 
      <button id="subscribe">Subscribe</button>
      <button id="private">Subscribe Private</button>
      <button id="unsubscribe">Unsubscribe</button>
    </div>
    
    <div class="panel">
      <button id="users">Users</button>
      <button id="topics">Topics</button>
    </div>
    
    <div class="panel">
      <input type="text" id="message" placeholder="Message">
      <button id="publish">Publish</button>
    </div>
    
    <div class="panel">
      <input type="text" id="offset" placeholder="Offset">
      <input type="text" id="limit" placeholder="Limit"> 
      <button id="history_t">History by Timestamp</button>
    </div>
    
    <p>Ops response</p>
    <pre id="output_op"></pre>
    <p>Messages</p>
    <pre id="output"></pre>
    
    <script>
      $(document).ready(function() {

        var xserv = new Xserv("9Pf80-3");
        // xserv.disableTLS();
        // xserv.setReconnectInterval(20000);

        xserv.addEventListener("connection_open", function() {
           $("#state").attr("fill", "green");
           $("#info").text(JSON.stringify(xserv.getUserData()));
	});

	xserv.addEventListener("connection_close", function(event) {
	    $("#state").attr("fill", "red");
	});

        xserv.addEventListener("connection_error", function(event) {
	    $("#state").attr("fill", "yellow");
	});

        var op_callback = function(json) {
            var html = "<div class='row'>" + JSON.stringify(json) + "</div>";
	    $(html).hide().prependTo("#output_op").fadeIn(1000);
            
            if (json.op == Xserv.OP_SUBSCRIBE && json.rc == Xserv.RC_OK && Xserv.isPrivateTopic(json.topic)) {
               $("#info").text(JSON.stringify(xserv.getUserData())); // more data
            }
        };

        var msg_callback = function(json) {
           var html = "<div class='row'>" + JSON.stringify(json) + "</div>";
            $(html).hide().prependTo("#output").fadeIn(1000);
        };

        xserv.addEventListener("operations", op_callback);

        xserv.addEventListener("messages", msg_callback);

        $("#connect").click(function() {
           xserv.connect();
        });

        $("#disconnect").click(function() {
           xserv.disconnect();
        });

        $("#clear").click(function() {
           $("#output_op").html("");
           $("#output").html("");
        });

        // example with commands callback

        $("#subscribe").click(function() {
           xserv.subscribe($("#topic").val(), op_callback);
        });

        $("#unsubscribe").click(function() {
           xserv.unsubscribe($("#topic").val(), op_callback);
        });

        $("#private").click(function() {
           // private topic
           xserv.subscribe($("#topic").val(), {
               params: {
                   user: $("#user").val(), 
                   pass: $("#pass").val()
               }
           }, op_callback);
        });

        $("#publish").click(function() {
          var data = $("#message").val();
          if (Xserv.Utils.isString(data)) {
            try {
              data = JSON.parse(data);
            } catch(e) {
            }
          }
          xserv.publish($("#topic").val(), data, op_callback);
        });

        $("#users").click(function() {
           xserv.users($("#topic").val(), op_callback);
        });

        $("#topics").click(function() {
           xserv.topics(op_callback);
        });

        $("#history_t").click(function() {
           xserv.history($("#topic").val(), $("#offset").val(), $("#limit").val(), op_callback);
        });

        xserv.connect();

      });
    </script>
  </body>
</html>
