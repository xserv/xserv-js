(function(){var t=function(n){var e="mobile-italia.com:4321",s="ws://"+e+"/ws",r="http://"+e+"/auth_user/",o=5e3,a=":";this.app_id=n,this.conn=null,this.is_finish_ops=!1,this.listeners=[],this.ops=[],this.reconnect_interval=o,this.is_auto_reconnect=!1,this.user_data={},this.isConnected=function(){return this.conn&&this.conn.readyState==WebSocket.OPEN},this.connect=function(){if(this.is_auto_reconnect=!0,!this.isConnected()){window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),this.conn=new WebSocket(s);for(var t in this.listeners)this.conn.addEventListener(this.listeners[t].event,this.listeners[t].callback);this.conn.onopen=function(t){for(var i in this.ops)c.bind(this)(this.ops[i]);this.is_finish_ops=!0}.bind(this),this.conn.onclose=function(t){this.is_finish_ops=!1,this.is_auto_reconnect&&setTimeout(this.connect.bind(this),this.reconnect_interval)}.bind(this)}},this.disconnect=function(){this.is_auto_reconnect=!1,this.isConnected()&&this.conn.close()},this.setReconnectInterval=function(t){this.reconnect_interval=t};var c=function(i){if(this.isConnected())if(i.op==t.BIND&&t.isPrivateTopic(i.topic))if(i.auth_endpoint){var n=i.auth_endpoint.endpoint||r+this.app_id,e=i.auth_endpoint.user||"",s=i.auth_endpoint.pass||"",o={topic:i.topic,user:e,pass:s};$.ajax({cache:!1,type:"post",url:n,contentType:"application/json; charset=UTF-8",data:JSON.stringify(o),processData:!1,dataType:"text"}).always(function(t){var n=$.extend({},i);try{var e=JSON.parse(t);e&&(n.arg1=o.user,n.arg2=JSON.stringify(e.data),n.arg3=e.sign)}catch(s){}this.conn.send(JSON.stringify(n))}.bind(this))}else this.conn.send(JSON.stringify(i));else this.conn.send(JSON.stringify(i))},h=function(i){(i.op==t.BIND||i.op==t.UNBIND)&&this.ops.push(i),this.is_finish_ops&&c.bind(this)(i)},d=function(t){return"string"==typeof t},p=function(t){return"object"==typeof t},f=function(t){return"[object Array]"===Object.prototype.toString.call(t)},_=function(t){this.user_data=t},u=function(i){return i==t.BIND?"bind":i==t.UNBIND?"unbind":i==t.HISTORY?"history":i==t.PRESENCE?"presence":i==t.PRESENCE_IN?"presence_in":i==t.PRESENCE_OUT?"presence_out":i==t.TRIGGER?"trigger":void 0};this.addEventListener=function(n,e){if("message"==n);else if("events"==n){var s=function(t){if(t.data.charAt(0)!=a){var i=JSON.parse(t.data);try{i.message=JSON.parse(i.message)}catch(n){}e(i)}}.bind(this);this.listeners.push({event:"message",callback:s})}else if("events:op"==n){var s=function(n){if(n.data.charAt(0)==a){var s=n.data.split(a);if(s.length>=7){var r=s[5]||null;if(r)try{r=i.decode(r),r=JSON.parse(r)}catch(o){}var c={rc:parseInt(s[1],10),op:parseInt(s[2],10),name:u(s[2]),topic:s[3],event:s[4],data:r,descr:s[6]};c.op==t.BIND&&t.isPrivateTopic(c.topic)&&c.rc==t.RC_OK&&_.bind(this)(c.data),e(c)}}}.bind(this);this.listeners.push({event:"message",callback:s})}else this.listeners.push({event:n,callback:e})},this.trigger=function(i,n,e){this.is_finish_ops&&(!d(e)&&p(e)&&(e=JSON.stringify(e)),c.bind(this)({app_id:this.app_id,op:t.TRIGGER,topic:i,event:n,arg1:e}))},this.bind=function(i,n,e){f(i)||(i=[i]),f(n)||(n=[n]);for(var s in i)for(var r in n)h.bind(this)({app_id:this.app_id,op:t.BIND,topic:i[s],event:n[r],auth_endpoint:e})},this.unbind=function(i,n){n=n||"",f(i)||(i=[i]),f(n)||(n=[n]);for(var e in i)for(var s in n)h.bind(this)({app_id:this.app_id,op:t.UNBIND,topic:i[e],event:n[s]})},this.historyById=function(i,n,e,s){h.bind(this)({app_id:this.app_id,op:t.HISTORY,topic:i,event:n,arg1:t.HISTORY_ID,arg2:String(e),arg3:String(s)})},this.historyByTimestamp=function(i,n,e,s){h.bind(this)({app_id:this.app_id,op:t.HISTORY,topic:i,event:n,arg1:t.HISTORY_TIMESTAMP,arg2:String(e),arg3:String(s)})},this.presence=function(i,n){h.bind(this)({app_id:this.app_id,op:t.PRESENCE,topic:i,event:n})}};t.isPrivateTopic=function(t){return"@"==t.charAt(0)},t.TRIGGER=200,t.BIND=201,t.UNBIND=202,t.HISTORY=203,t.PRESENCE=204,t.PRESENCE_IN=t.BIND+200,t.PRESENCE_OUT=t.UNBIND+200,t.HISTORY_ID="id",t.HISTORY_TIMESTAMP="timestamp",t.RC_OK=1,t.RC_GENERIC_ERROR=0,t.RC_ARGS_ERROR=-1,t.RC_ALREADY_BINDED=-2,t.RC_UNAUTHORIZED=-3,t.RC_NO_EVENT=-4,t.RC_NO_DATA=-5,t.RC_NOT_PRIVATE=-6,this.Xserv=t;var i={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var n,e,s,r,o,a,c,h="",d=0;for(t=i._utf8_encode(t);d<t.length;)n=t.charCodeAt(d++),e=t.charCodeAt(d++),s=t.charCodeAt(d++),r=n>>2,o=(3&n)<<4|e>>4,a=(15&e)<<2|s>>6,c=63&s,isNaN(e)?a=c=64:isNaN(s)&&(c=64),h=h+this._keyStr.charAt(r)+this._keyStr.charAt(o)+this._keyStr.charAt(a)+this._keyStr.charAt(c);return h},decode:function(t){var n,e,s,r,o,a,c,h="",d=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");d<t.length;)r=this._keyStr.indexOf(t.charAt(d++)),o=this._keyStr.indexOf(t.charAt(d++)),a=this._keyStr.indexOf(t.charAt(d++)),c=this._keyStr.indexOf(t.charAt(d++)),n=r<<2|o>>4,e=(15&o)<<4|a>>2,s=(3&a)<<6|c,h+=String.fromCharCode(n),64!=a&&(h+=String.fromCharCode(e)),64!=c&&(h+=String.fromCharCode(s));return h=i._utf8_decode(h)},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var i="",n=0;n<t.length;n++){var e=t.charCodeAt(n);128>e?i+=String.fromCharCode(e):e>127&&2048>e?(i+=String.fromCharCode(e>>6|192),i+=String.fromCharCode(63&e|128)):(i+=String.fromCharCode(e>>12|224),i+=String.fromCharCode(e>>6&63|128),i+=String.fromCharCode(63&e|128))}return i},_utf8_decode:function(t){for(var i="",n=0,e=c1=c2=0;n<t.length;)e=t.charCodeAt(n),128>e?(i+=String.fromCharCode(e),n++):e>191&&224>e?(c2=t.charCodeAt(n+1),i+=String.fromCharCode((31&e)<<6|63&c2),n+=2):(c2=t.charCodeAt(n+1),c3=t.charCodeAt(n+2),i+=String.fromCharCode((15&e)<<12|(63&c2)<<6|63&c3),n+=3);return i}}}).call(this);