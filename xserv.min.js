!function(t,e){"function"==typeof define&&define.amd?define([],function(){return t.Xserv=e()}):"object"==typeof exports?module.exports=e():t.Xserv=e()}(this,function(){return function(){function t(e){this.app_id=e,this.conn=null,this.listeners=[],this.user_data={},this.reconnect_interval=t.DEFAULT_RI,this.instanceUUID=t.Utils.generateUUID(),this.is_auto_reconnect=!1}var e=t.prototype,n=function(){setTimeout(function(){this.connect(!0)}.bind(this),this.reconnect_interval)},i=function(){var e=t.Utils.getInfoBrowser(),n=t.Utils.getTimeZoneData(),i=e.browser||"",r=e.os||"";i.length>45&&(i=i.substring(0,45)),r.length>45&&(r=r.substring(0,45));var s={uuid:this.instanceUUID,model:i,os:r,tz_offset:n.tz_offset,tz_dst:n.tz_dst};this.conn.send(JSON.stringify(s))},r=function(e){if(this.isConnected())if(e.op==t.BIND&&t.isPrivateTopic(e.topic)&&e.auth_endpoint){var n=e.auth_endpoint.endpoint||t.Utils.format(t.DEFAULT_AUTH_URL,{$1:t.ADDRESS,$2:t.PORT,$3:this.app_id}),i=e.auth_endpoint.user||"",r=e.auth_endpoint.pass||"",s={topic:e.topic,user:i,pass:r};$.ajax({cache:!1,crossDomain:!0,type:"post",url:n,contentType:"application/json; charset=UTF-8",data:JSON.stringify(s),processData:!1,dataType:"json"}).always(function(t){var n=$.extend({},e);delete n.auth_endpoint,t&&(n.arg1=s.user,n.arg2=t.data,n.arg3=t.sign),this.conn.send(JSON.stringify(n))}.bind(this))}else this.conn.send(JSON.stringify(e))},s=function(t){this.user_data=t},o=function(e){return e==t.BIND?"bind":e==t.UNBIND?"unbind":e==t.HISTORY?"history":e==t.PRESENCE?"presence":e==t.PRESENCE_IN?"presence_in":e==t.PRESENCE_OUT?"presence_out":e==t.TRIGGER?"trigger":void 0};t.isPrivateTopic=function(t){return"@"==t.charAt(0)},e.isConnected=function(){return this.conn&&this.conn.readyState==WebSocket.OPEN},e.connect=function(e){if(e||(this.is_auto_reconnect=!0),!this.isConnected()){if(window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),this.conn){for(var r in this.listeners)this.conn.removeEventListener(this.listeners[r].event,this.listeners[r].callback);delete this.conn}this.conn=new WebSocket(t.Utils.format(t.URL,{$1:t.ADDRESS,$2:t.PORT,$3:this.app_id}));for(var r in this.listeners)this.conn.addEventListener(this.listeners[r].event,this.listeners[r].callback);this.conn.onopen=function(t){i.bind(this)()}.bind(this),this.conn.onclose=function(t){this.is_auto_reconnect&&n.bind(this)()}.bind(this)}},e.disconnect=function(){this.is_auto_reconnect=!1,this.isConnected()&&this.conn.close()},e.addEventListener=function(e,n){if("receive_events"==e){var i=function(t){var e=JSON.parse(t.data);if(e.message){try{e.message=JSON.parse(e.message)}catch(i){}n(e)}}.bind(this);this.listeners.push({event:"message",callback:i})}else if("receive_ops_response"==e){var i=function(e){var i=JSON.parse(e.data);if(i.op){i.name=o(i.op);try{var r=t.Utils.Base64.decode(i.data);r=JSON.parse(r),i.data=r,i.op==t.BIND&&t.isPrivateTopic(i.topic)&&i.rc==t.RC_OK&&t.Utils.isObject(i.data)&&s.bind(this)(i.data)}catch(a){}n(i)}}.bind(this);this.listeners.push({event:"message",callback:i})}else"open_connection"==e?this.listeners.push({event:"open",callback:n}):"close_connection"==e?this.listeners.push({event:"close",callback:n}):"error_connection"==e&&this.listeners.push({event:"error",callback:n})},e.setReconnectInterval=function(t){this.reconnect_interval=t},e.getReconnectInterval=function(){return this.reconnect_interval},e.getUserData=function(){return this.user_data},e.trigger=function(e,n,i){if(this.isConnected()){var s=t.Utils.generateUUID();return!t.Utils.isString(i)&&t.Utils.isObject(i)&&(i=JSON.stringify(i)),r.bind(this)({uuid:s,op:t.TRIGGER,topic:e,event:n,arg1:i}),s}},e.bind=function(e,n,i){if(this.isConnected()){var s=t.Utils.generateUUID(),o={uuid:s,op:t.BIND,topic:e,event:n};return i&&(o.auth_endpoint=i),r.bind(this)(o),s}},e.unbind=function(e,n){if(this.isConnected()){var i=t.Utils.generateUUID();return n=n||"",r.bind(this)({uuid:i,op:t.UNBIND,topic:e,event:n}),i}},e.historyById=function(e,n,i,s){if(this.isConnected()){var o=t.Utils.generateUUID();return r.bind(this)({uuid:o,op:t.HISTORY,topic:e,event:n,arg1:t.HISTORY_ID,arg2:String(i),arg3:String(s)}),o}},e.historyByTimestamp=function(e,n,i,s){if(this.isConnected()){var o=t.Utils.generateUUID();return r.bind(this)({uuid:o,op:t.HISTORY,topic:e,event:n,arg1:t.HISTORY_TIMESTAMP,arg2:String(i),arg3:String(s)}),o}},e.presence=function(e,n){if(this.isConnected()){var i=t.Utils.generateUUID();return r.bind(this)({uuid:i,op:t.PRESENCE,topic:e,event:n}),i}},this.Xserv=t}.call(this),function(){Xserv.Utils={format:function(t,e){var n=t;for(var i in e)n=n.replace(new RegExp("\\"+i,"g"),e[i]);return n},isString:function(t){return"string"==typeof t},isObject:function(t){return"object"==typeof t},isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},generateUUID:function(){var t=(new Date).getTime(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:3&n|8).toString(16)});return e},getTimeZoneData:function(){var t=new Date,e=new Date(t.getFullYear(),0,1),n=new Date(t.getFullYear(),6,1),i=t.getTimezoneOffset()<Math.max(e.getTimezoneOffset(),n.getTimezoneOffset());return{tz_offset:-1*parseInt(t.getTimezoneOffset()/60),tz_dst:+i}},getInfoBrowser:function(){var t,e,n,i=navigator.userAgent,r=navigator.appName,s=""+parseFloat(navigator.appVersion);-1!=(e=i.indexOf("Opera"))?(r="Opera",s=i.substring(e+6),-1!=(e=i.indexOf("Version"))&&(s=i.substring(e+8))):-1!=(e=i.indexOf("MSIE"))?(r="Microsoft Internet Explorer",s=i.substring(e+5)):-1!=(e=i.indexOf("Chrome"))?(r="Chrome",s=i.substring(e+7)):-1!=(e=i.indexOf("Safari"))?(r="Safari",s=i.substring(e+7),-1!=(e=i.indexOf("Version"))&&(s=i.substring(e+8))):-1!=(e=i.indexOf("Firefox"))?(r="Firefox",s=i.substring(e+8)):(t=i.lastIndexOf(" ")+1)<(e=i.lastIndexOf("/"))&&(r=i.substring(t,e),s=i.substring(e+1),r.toLowerCase()==r.toUpperCase()&&(r=navigator.appName)),-1!=(n=s.indexOf(";"))&&(s=s.substring(0,n)),-1!=(n=s.indexOf(" "))&&(s=s.substring(0,n));var o=parseInt(""+s,10);isNaN(o)&&(s=""+parseFloat(navigator.appVersion));var a="Unknown";try{a=i.split("(")[1].split(")")[0]}catch(c){}return{browser:r+" "+s,os:a}}}}.call(this),function(){var t={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var n,i,r,s,o,a,c,h="",f=0;for(e=t._utf8_encode(e);f<e.length;)n=e.charCodeAt(f++),i=e.charCodeAt(f++),r=e.charCodeAt(f++),s=n>>2,o=(3&n)<<4|i>>4,a=(15&i)<<2|r>>6,c=63&r,isNaN(i)?a=c=64:isNaN(r)&&(c=64),h=h+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(a)+this._keyStr.charAt(c);return h},decode:function(e){var n,i,r,s,o,a,c,h="",f=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");f<e.length;)s=this._keyStr.indexOf(e.charAt(f++)),o=this._keyStr.indexOf(e.charAt(f++)),a=this._keyStr.indexOf(e.charAt(f++)),c=this._keyStr.indexOf(e.charAt(f++)),n=s<<2|o>>4,i=(15&o)<<4|a>>2,r=(3&a)<<6|c,h+=String.fromCharCode(n),64!=a&&(h+=String.fromCharCode(i)),64!=c&&(h+=String.fromCharCode(r));return h=t._utf8_decode(h)},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var e="",n=0;n<t.length;n++){var i=t.charCodeAt(n);128>i?e+=String.fromCharCode(i):i>127&&2048>i?(e+=String.fromCharCode(i>>6|192),e+=String.fromCharCode(63&i|128)):(e+=String.fromCharCode(i>>12|224),e+=String.fromCharCode(i>>6&63|128),e+=String.fromCharCode(63&i|128))}return e},_utf8_decode:function(t){for(var e="",n=0,i=c1=c2=0;n<t.length;)i=t.charCodeAt(n),128>i?(e+=String.fromCharCode(i),n++):i>191&&224>i?(c2=t.charCodeAt(n+1),e+=String.fromCharCode((31&i)<<6|63&c2),n+=2):(c2=t.charCodeAt(n+1),c3=t.charCodeAt(n+2),e+=String.fromCharCode((15&i)<<12|(63&c2)<<6|63&c3),n+=3);return e}};Xserv.Utils.Base64=t}.call(this),function(){Xserv.VERSION="1.0.0",Xserv.ADDRESS="xserv.mobile-italia.com",Xserv.PORT="4332",Xserv.URL="ws://$1:$2/ws/$3",Xserv.DEFAULT_AUTH_URL="http://$1:$2/app/$3/auth_user",Xserv.DEFAULT_RI=5e3,Xserv.TRIGGER=200,Xserv.BIND=201,Xserv.UNBIND=202,Xserv.HISTORY=203,Xserv.PRESENCE=204,Xserv.PRESENCE_IN=Xserv.BIND+200,Xserv.PRESENCE_OUT=Xserv.UNBIND+200,Xserv.HISTORY_ID="id",Xserv.HISTORY_TIMESTAMP="timestamp",Xserv.RC_OK=1,Xserv.RC_GENERIC_ERROR=0,Xserv.RC_ARGS_ERROR=-1,Xserv.RC_ALREADY_BINDED=-2,Xserv.RC_UNAUTHORIZED=-3,Xserv.RC_NO_EVENT=-4,Xserv.RC_NO_DATA=-5,Xserv.RC_NOT_PRIVATE=-6}.call(this),Xserv});