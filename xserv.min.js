(function(){var t=function(n){var e="mobile-italia.com",r=":5555",s="ws://"+e+r+"/ws/"+n,o="http://"+e+r+"/app/"+n+"/auth_user",a=5e3,c=":";this.app_id=n,this.conn=null,this.ops=[],this.listeners=[],this.user_data={},this.reconnect_interval=a,this.is_auto_reconnect=!1,this.is_backup_act=!0,this.in_initialization=!1,this.isConnected=function(){return this.conn&&this.conn.readyState==WebSocket.OPEN},this.connect=function(t){if(t||(this.is_auto_reconnect=!0),!this.isConnected()&&!this.in_initialization){this.in_initialization=!0,window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),this.conn=new WebSocket(s);for(var i in this.listeners)this.conn.addEventListener(this.listeners[i].event,this.listeners[i].callback);this.conn.onopen=function(t){for(var i in this.ops)h.bind(this)(this.ops[i]);this.in_initialization=!1}.bind(this),this.conn.onclose=function(t){this.is_auto_reconnect&&this.setTimeout(),this.in_initialization=!1}.bind(this)}},this.setTimeout=function(){setTimeout(function(){this.connect(!0)}.bind(this),this.reconnect_interval)},this.disconnect=function(){this.is_auto_reconnect=!1,this.isConnected()&&this.conn.close()},this.setReconnectInterval=function(t){this.reconnect_interval=t},this.setBackupOps=function(t){this.is_backup_act=t};var h=function(i){if(this.isConnected())if(i.op==t.BIND&&t.isPrivateTopic(i.topic))if(i.auth_endpoint){var n=i.auth_endpoint.endpoint||o,e=i.auth_endpoint.user||"",r=i.auth_endpoint.pass||"",s={topic:i.topic,user:e,pass:r};$.ajax({cache:!1,crossDomain:!0,type:"post",url:n,contentType:"application/json; charset=UTF-8",data:JSON.stringify(s),processData:!1,dataType:"json"}).always(function(t){var n=$.extend({},i);t&&(n.arg1=s.user,n.arg2=t.data,n.arg3=t.sign),this.conn.send(JSON.stringify(n))}.bind(this))}else this.conn.send(JSON.stringify(i));else this.conn.send(JSON.stringify(i))},d=function(i){!this.is_backup_act||i.op!=t.BIND&&i.op!=t.UNBIND||this.ops.push(i),h.bind(this)(i)},f=function(t){return"string"==typeof t},u=function(t){return"object"==typeof t},p=function(t){return"[object Array]"===Object.prototype.toString.call(t)},_=function(t){this.user_data=t},S=function(i){return i==t.BIND?"bind":i==t.UNBIND?"unbind":i==t.HISTORY?"history":i==t.PRESENCE?"presence":i==t.PRESENCE_IN?"presence_in":i==t.PRESENCE_OUT?"presence_out":i==t.TRIGGER?"trigger":void 0};this.addEventListener=function(n,e){if("message"==n);else if("events"==n){var r=function(t){if(t.data.charAt(0)!=c){var i=JSON.parse(t.data);try{i.message=JSON.parse(i.message)}catch(n){}e(i)}}.bind(this);this.listeners.push({event:"message",callback:r})}else if("ops"==n){var r=function(n){if(n.data.charAt(0)==c){var r=n.data.split(c);if(r.length>=7){var s=r[5]||null;if(s)try{s=i.decode(s),s=JSON.parse(s)}catch(o){}var a={rc:parseInt(r[1],10),op:parseInt(r[2],10),name:S(r[2]),topic:r[3],event:r[4],data:s,descr:r[6]};a.op==t.BIND&&t.isPrivateTopic(a.topic)&&a.rc==t.RC_OK&&_.bind(this)(a.data),e(a)}}}.bind(this);this.listeners.push({event:"message",callback:r})}else this.listeners.push({event:n,callback:e})},this.trigger=function(i,n,e){!f(e)&&u(e)&&(e=JSON.stringify(e)),d.bind(this)({op:t.TRIGGER,topic:i,event:n,arg1:e})},this.bind=function(i,n,e){p(i)||(i=[i]),p(n)||(n=[n]);for(var r in i)for(var s in n)d.bind(this)({op:t.BIND,topic:i[r],event:n[s],auth_endpoint:e})},this.unbind=function(i,n){n=n||"",p(i)||(i=[i]),p(n)||(n=[n]);for(var e in i)for(var r in n)d.bind(this)({op:t.UNBIND,topic:i[e],event:n[r]})},this.historyById=function(i,n,e,r){d.bind(this)({op:t.HISTORY,topic:i,event:n,arg1:t.HISTORY_ID,arg2:String(e),arg3:String(r)})},this.historyByTimestamp=function(i,n,e,r){d.bind(this)({op:t.HISTORY,topic:i,event:n,arg1:t.HISTORY_TIMESTAMP,arg2:String(e),arg3:String(r)})},this.presence=function(i,n){d.bind(this)({op:t.PRESENCE,topic:i,event:n})}};t.isPrivateTopic=function(t){return"@"==t.charAt(0)},t.TRIGGER=200,t.BIND=201,t.UNBIND=202,t.HISTORY=203,t.PRESENCE=204,t.PRESENCE_IN=t.BIND+200,t.PRESENCE_OUT=t.UNBIND+200,t.HISTORY_ID="id",t.HISTORY_TIMESTAMP="timestamp",t.RC_OK=1,t.RC_GENERIC_ERROR=0,t.RC_ARGS_ERROR=-1,t.RC_ALREADY_BINDED=-2,t.RC_UNAUTHORIZED=-3,t.RC_NO_EVENT=-4,t.RC_NO_DATA=-5,t.RC_NOT_PRIVATE=-6,this.Xserv=t;var i={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var n,e,r,s,o,a,c,h="",d=0;for(t=i._utf8_encode(t);d<t.length;)n=t.charCodeAt(d++),e=t.charCodeAt(d++),r=t.charCodeAt(d++),s=n>>2,o=(3&n)<<4|e>>4,a=(15&e)<<2|r>>6,c=63&r,isNaN(e)?a=c=64:isNaN(r)&&(c=64),h=h+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(a)+this._keyStr.charAt(c);return h},decode:function(t){var n,e,r,s,o,a,c,h="",d=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");d<t.length;)s=this._keyStr.indexOf(t.charAt(d++)),o=this._keyStr.indexOf(t.charAt(d++)),a=this._keyStr.indexOf(t.charAt(d++)),c=this._keyStr.indexOf(t.charAt(d++)),n=s<<2|o>>4,e=(15&o)<<4|a>>2,r=(3&a)<<6|c,h+=String.fromCharCode(n),64!=a&&(h+=String.fromCharCode(e)),64!=c&&(h+=String.fromCharCode(r));return h=i._utf8_decode(h)},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var i="",n=0;n<t.length;n++){var e=t.charCodeAt(n);128>e?i+=String.fromCharCode(e):e>127&&2048>e?(i+=String.fromCharCode(e>>6|192),i+=String.fromCharCode(63&e|128)):(i+=String.fromCharCode(e>>12|224),i+=String.fromCharCode(e>>6&63|128),i+=String.fromCharCode(63&e|128))}return i},_utf8_decode:function(t){for(var i="",n=0,e=c1=c2=0;n<t.length;)e=t.charCodeAt(n),128>e?(i+=String.fromCharCode(e),n++):e>191&&224>e?(c2=t.charCodeAt(n+1),i+=String.fromCharCode((31&e)<<6|63&c2),n+=2):(c2=t.charCodeAt(n+1),c3=t.charCodeAt(n+2),i+=String.fromCharCode((15&e)<<12|(63&c2)<<6|63&c3),n+=3);return i}}}).call(this);