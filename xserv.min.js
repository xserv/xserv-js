(function(){var t=function(o){var a="xserv.mobile-italia.com",s="4332",c="ws://"+a+":"+s+"/ws/"+o,d="http://"+a+":"+s+"/app/"+o+"/auth_user",f=5e3,u=null,h=[],p={},g=f,v=e(),C=!1;this.isConnected=function(){return u&&u.readyState==WebSocket.OPEN},this.connect=function(t){if(t||(C=!0),!this.isConnected()){if(window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),u){for(var e in h)u.removeEventListener(h[e].event,h[e].callback);delete u}u=new WebSocket(c);for(var e in h)u.addEventListener(h[e].event,h[e].callback);u.onopen=function(t){_.bind(this)()}.bind(this),u.onclose=function(t){C&&S.bind(this)()}.bind(this)}};var S=function(){setTimeout(function(){this.connect(!0)}.bind(this),g)};this.disconnect=function(){C=!1,this.isConnected()&&u.close()},this.setReconnectInterval=function(t){g=t},this.getReconnectInterval=function(){return g},this.getUserData=function(){return p};var _=function(){var t=i(),e=n(),r=t.browser||"",o=t.os||"";r.length>45&&(r=r.substring(0,45)),o.length>45&&(o=o.substring(0,45));var a={uuid:v,model:r,os:o,tz_offset:e.tz_offset,tz_dst:e.tz_dst};u.send(JSON.stringify(a))},l=function(e){if(this.isConnected())if(e.op==t.BIND&&t.isPrivateTopic(e.topic)&&e.auth_endpoint){var n=e.auth_endpoint.endpoint||d,i=e.auth_endpoint.user||"",r=e.auth_endpoint.pass||"",o={topic:e.topic,user:i,pass:r};$.ajax({cache:!1,crossDomain:!0,type:"post",url:n,contentType:"application/json; charset=UTF-8",data:JSON.stringify(o),processData:!1,dataType:"json"}).always(function(t){var n=$.extend({},e);delete n.auth_endpoint,t&&(n.arg1=o.user,n.arg2=t.data,n.arg3=t.sign),u.send(JSON.stringify(n))}.bind(this))}else u.send(JSON.stringify(e))},x=function(t){return"string"==typeof t},O=function(t){return"object"==typeof t},b=function(t){p=t},N=function(e){return e==t.BIND?"bind":e==t.UNBIND?"unbind":e==t.HISTORY?"history":e==t.PRESENCE?"presence":e==t.PRESENCE_IN?"presence_in":e==t.PRESENCE_OUT?"presence_out":e==t.TRIGGER?"trigger":void 0};this.addEventListener=function(e,n){if("receive_events"==e){var i=function(t){var e=JSON.parse(t.data);if(e.message){try{e.message=JSON.parse(e.message)}catch(i){}n(e)}}.bind(this);h.push({event:"message",callback:i})}else if("receive_ops_response"==e){var i=function(e){var i=JSON.parse(e.data);if(i.op){i.name=N(i.op);try{var o=r.decode(i.data);o=JSON.parse(o),i.data=o,i.op==t.BIND&&t.isPrivateTopic(i.topic)&&i.rc==t.RC_OK&&O(i.data)&&b.bind(this)(i.data)}catch(a){}n(i)}}.bind(this);h.push({event:"message",callback:i})}else"open_connection"==e?h.push({event:"open",callback:n}):"close_connection"==e?h.push({event:"close",callback:n}):"error_connection"==e&&h.push({event:"error",callback:n})},this.trigger=function(n,i,r){if(this.isConnected()){var o=e();return!x(r)&&O(r)&&(r=JSON.stringify(r)),l.bind(this)({uuid:o,op:t.TRIGGER,topic:n,event:i,arg1:r}),o}},this.bind=function(n,i,r){if(this.isConnected()){var o=e(),a={uuid:o,op:t.BIND,topic:n,event:i};return r&&(a.auth_endpoint=r),l.bind(this)(a),o}},this.unbind=function(n,i){if(this.isConnected()){var r=e();return i=i||"",l.bind(this)({uuid:r,op:t.UNBIND,topic:n,event:i}),r}},this.historyById=function(n,i,r,o){if(this.isConnected()){var a=e();return l.bind(this)({uuid:a,op:t.HISTORY,topic:n,event:i,arg1:t.HISTORY_ID,arg2:String(r),arg3:String(o)}),a}},this.historyByTimestamp=function(n,i,r,o){if(this.isConnected()){var a=e();return l.bind(this)({uuid:a,op:t.HISTORY,topic:n,event:i,arg1:t.HISTORY_TIMESTAMP,arg2:String(r),arg3:String(o)}),a}},this.presence=function(n,i){if(this.isConnected()){var r=e();return l.bind(this)({uuid:r,op:t.PRESENCE,topic:n,event:i}),r}}};t.isPrivateTopic=function(t){return"@"==t.charAt(0)},t.TRIGGER=200,t.BIND=201,t.UNBIND=202,t.HISTORY=203,t.PRESENCE=204,t.PRESENCE_IN=t.BIND+200,t.PRESENCE_OUT=t.UNBIND+200,t.HISTORY_ID="id",t.HISTORY_TIMESTAMP="timestamp",t.RC_OK=1,t.RC_GENERIC_ERROR=0,t.RC_ARGS_ERROR=-1,t.RC_ALREADY_BINDED=-2,t.RC_UNAUTHORIZED=-3,t.RC_NO_EVENT=-4,t.RC_NO_DATA=-5,t.RC_NOT_PRIVATE=-6,this.Xserv=t;var e=function(){var t=(new Date).getTime(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:3&n|8).toString(16)});return e},n=function(){var t=new Date,e=new Date(t.getFullYear(),0,1),n=new Date(t.getFullYear(),6,1),i=t.getTimezoneOffset()<Math.max(e.getTimezoneOffset(),n.getTimezoneOffset());return{tz_offset:-1*parseInt(t.getTimezoneOffset()/60),tz_dst:+i}},i=function(){var t,e,n,i=navigator.userAgent,r=navigator.appName,o=""+parseFloat(navigator.appVersion);-1!=(e=i.indexOf("Opera"))?(r="Opera",o=i.substring(e+6),-1!=(e=i.indexOf("Version"))&&(o=i.substring(e+8))):-1!=(e=i.indexOf("MSIE"))?(r="Microsoft Internet Explorer",o=i.substring(e+5)):-1!=(e=i.indexOf("Chrome"))?(r="Chrome",o=i.substring(e+7)):-1!=(e=i.indexOf("Safari"))?(r="Safari",o=i.substring(e+7),-1!=(e=i.indexOf("Version"))&&(o=i.substring(e+8))):-1!=(e=i.indexOf("Firefox"))?(r="Firefox",o=i.substring(e+8)):(t=i.lastIndexOf(" ")+1)<(e=i.lastIndexOf("/"))&&(r=i.substring(t,e),o=i.substring(e+1),r.toLowerCase()==r.toUpperCase()&&(r=navigator.appName)),-1!=(n=o.indexOf(";"))&&(o=o.substring(0,n)),-1!=(n=o.indexOf(" "))&&(o=o.substring(0,n));var a=parseInt(""+o,10);isNaN(a)&&(o=""+parseFloat(navigator.appVersion));var s="Unknown";try{s=i.split("(")[1].split(")")[0]}catch(c){}return{browser:r+" "+o,os:s}},r={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var e,n,i,o,a,s,c,d="",f=0;for(t=r._utf8_encode(t);f<t.length;)e=t.charCodeAt(f++),n=t.charCodeAt(f++),i=t.charCodeAt(f++),o=e>>2,a=(3&e)<<4|n>>4,s=(15&n)<<2|i>>6,c=63&i,isNaN(n)?s=c=64:isNaN(i)&&(c=64),d=d+this._keyStr.charAt(o)+this._keyStr.charAt(a)+this._keyStr.charAt(s)+this._keyStr.charAt(c);return d},decode:function(t){var e,n,i,o,a,s,c,d="",f=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");f<t.length;)o=this._keyStr.indexOf(t.charAt(f++)),a=this._keyStr.indexOf(t.charAt(f++)),s=this._keyStr.indexOf(t.charAt(f++)),c=this._keyStr.indexOf(t.charAt(f++)),e=o<<2|a>>4,n=(15&a)<<4|s>>2,i=(3&s)<<6|c,d+=String.fromCharCode(e),64!=s&&(d+=String.fromCharCode(n)),64!=c&&(d+=String.fromCharCode(i));return d=r._utf8_decode(d)},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var e="",n=0;n<t.length;n++){var i=t.charCodeAt(n);128>i?e+=String.fromCharCode(i):i>127&&2048>i?(e+=String.fromCharCode(i>>6|192),e+=String.fromCharCode(63&i|128)):(e+=String.fromCharCode(i>>12|224),e+=String.fromCharCode(i>>6&63|128),e+=String.fromCharCode(63&i|128))}return e},_utf8_decode:function(t){for(var e="",n=0,i=c1=c2=0;n<t.length;)i=t.charCodeAt(n),128>i?(e+=String.fromCharCode(i),n++):i>191&&224>i?(c2=t.charCodeAt(n+1),e+=String.fromCharCode((31&i)<<6|63&c2),n+=2):(c2=t.charCodeAt(n+1),c3=t.charCodeAt(n+2),e+=String.fromCharCode((15&i)<<12|(63&c2)<<6|63&c3),n+=3);return e}}}).call(this);