!function(t,e){"function"==typeof define&&define.amd?define([],function(){return t.Xserv=e()}):"object"==typeof exports?module.exports=e():t.Xserv=e()}(this,function(){return function(){function t(e){this.app_id=e,this.conn=null,this.user_data={},this.reconnect_interval=t.DEFAULT_RI,this.instanceUUID=t.Utils.generateUUID(),this.is_auto_reconnect=!1,this.secure=!0,this.callbacks={}}var e=t.prototype,i=function(){this.is_auto_reconnect&&this.reconnect_interval>0&&setTimeout(function(){this.connect(!0)}.bind(this),this.reconnect_interval)},n=function(){var e=t.Utils.getBrowser(),i=t.Utils.getTimeZoneData(),n=e||"",r="Browser";n.length>45&&(n=n.substring(0,45)),r.length>45&&(r=r.substring(0,45));var s=navigator.language||navigator.userLanguage;s=s.replace("_","-");var o={uuid:this.instanceUUID,model:n,os:r,tz_offset:i.tz_offset,tz_dst:i.tz_dst,lang:s};this.conn.send(JSON.stringify(o))},r=function(e){if(this.isConnected())if(e.op==t.OP_SUBSCRIBE&&t.isPrivateTopic(e.topic)&&e.auth){var i=e.auth.endpoint||t.Utils.format(t.DEFAULT_AUTH_URL,{$1:this.secure?"s":"",$2:t.HOST,$3:this.secure?t.TLS_PORT:t.PORT}),n=e.auth.headers||{};n["X-Xserv-AppId"]=this.app_id;var r=e.auth.params||{},s=r.user||"",o=$.extend({socket_id:this.getSocketId(),topic:e.topic},r),a={cache:!1,crossDomain:!0,type:"get",url:i,headers:n,data:$.param(o),dataType:"json"};$.ajax(a).always(function(t){delete e.auth,t&&(e.arg1=s,e.arg2=t.data,e.arg3=t.sign),this.conn.send(JSON.stringify(e))}.bind(this))}else this.conn.send(JSON.stringify(e))},s=function(e){var i=null;try{i=JSON.parse(e.data)}catch(n){}if(i)if(i.op){if(i.op){i.data=t.Utils.Base64.decode(i.data);try{i.data=JSON.parse(i.data)}catch(n){}i.name=a(i.op),i.op==t.OP_HANDSHAKE?i.rc==t.RC_OK&&!t.Utils.isString(i.data)&&t.Utils.isObject(i.data)?(o.bind(this)(i.data),this.connection_open&&this.connection_open()):(this.callbacks={},this.connection_error&&this.connection_error(i)):(i.op==t.OP_SUBSCRIBE&&t.isPrivateTopic(i.topic)&&i.rc==t.RC_OK&&!t.Utils.isString(i.data)&&t.Utils.isObject(i.data)&&o.bind(this)(i.data),this.callbacks[i.uuid]?(this.callbacks[i.uuid](i),delete this.callbacks[i.uuid]):this.receive_ops_response&&this.receive_ops_response(i))}}else this.receive_messages&&this.receive_messages(i)},o=function(t){this.user_data=t},a=function(e){return e==t.OP_SUBSCRIBE?"subscribe":e==t.OP_UNSUBSCRIBE?"unsubscribe":e==t.OP_HISTORY?"history":e==t.OP_USERS?"users":e==t.OP_JOIN?"join":e==t.OP_LEAVE?"leave":e==t.OP_PUBLISH?"publish":e==t.OP_HANDSHAKE?"handshake":e==t.OP_TOPICS?"topics":e==t.OP_UPDATE?"update":e==t.OP_UPDATE_ALL?"update_all":e==t.OP_DELETE?"delete":e==t.OP_DELETE_ALL?"delete_all":""};t.isPrivateTopic=function(t){return"@"==t.charAt(0)},e.createExtra=function(e,i,n){if("webrtc"==e){var r=$("#"+n);r&&r.html('<iframe scrolling="no" src="https://'+t.HOST+":8000/?app_id="+this.app_id+"&room="+i.replace("@","priv_")+'"></iframe>')}},e.disableTLS=function(){this.secure=!1},e.isConnected=function(){return this.conn&&this.conn.readyState==WebSocket.OPEN},e.connect=function(e){e||(this.is_auto_reconnect=!0),this.isConnected()||(window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),this.conn&&delete this.conn,this.callbacks={},this.conn=new WebSocket(t.Utils.format(t.WS_URL,{$1:this.secure?"s":"",$2:t.HOST,$3:this.secure?t.TLS_PORT:t.PORT,$4:this.app_id,$5:t.VERSION})),this.conn.onopen=function(t){n.bind(this)()}.bind(this),this.conn.onclose=function(t){this.callbacks={},this.connection_close&&this.connection_close(t),i.bind(this)()}.bind(this),this.conn.onerror=function(t){this.callbacks={},this.connection_error&&this.connection_error(t)}.bind(this),this.conn.onmessage=function(t){s.bind(this)(t)}.bind(this))},e.disconnect=function(){this.is_auto_reconnect=!1,this.isConnected()&&this.conn.close()},e.addEventListener=function(t,e){"connection_open"==t?this.connection_open=e:"connection_close"==t?this.connection_close=e:"connection_error"==t?this.connection_error=e:"operations"==t?this.receive_ops_response=e:"messages"==t&&(this.receive_messages=e)},e.setReconnectInterval=function(t){this.reconnect_interval=t},e.getReconnectInterval=function(){return this.reconnect_interval},e.getUserData=function(){return this.user_data},e.getSocketId=function(){return this.user_data.socket_id?this.user_data.socket_id:""},e.publish=function(e,i,n){if(this.isConnected()){var s=t.Utils.generateUUID();return n&&(this.callbacks[s]=n),r.bind(this)({uuid:s,op:t.OP_PUBLISH,topic:e,arg1:i}),s}},e.update=function(e,i,n,s){if(this.isConnected()){var o=t.Utils.generateUUID();return s&&(this.callbacks[o]=s),r.bind(this)({uuid:o,op:t.OP_UPDATE,topic:e,arg1:n,arg2:i}),o}},e["delete"]=function(e,i,n){if(this.isConnected()){var s=t.Utils.generateUUID();return n&&(this.callbacks[s]=n),r.bind(this)({uuid:s,op:t.OP_DELETE,topic:e,arg2:i}),s}},e.subscribe=function(e,i,n){if(this.isConnected()){i&&t.Utils.isFunction(i)&&(n=i,i=null);var s=t.Utils.generateUUID();n&&(this.callbacks[s]=n);var o={uuid:s,op:t.OP_SUBSCRIBE,topic:e};return i&&t.Utils.isObject(i)&&(o.auth=i),r.bind(this)(o),s}},e.unsubscribe=function(e,i){if(this.isConnected()){var n=t.Utils.generateUUID();return i&&(this.callbacks[n]=i),r.bind(this)({uuid:n,op:t.OP_UNSUBSCRIBE,topic:e}),n}},e.history=function(e,i,n){if(this.isConnected()){var s=t.Utils.generateUUID();return n&&(this.callbacks[s]=n),r.bind(this)({uuid:s,op:t.OP_HISTORY,topic:e,arg1:String(i.offset?i.offset:0),arg2:String(i.limit?i.limit:0),arg3:i.query?i.query:""}),s}},e.users=function(e,i){if(this.isConnected()){var n=t.Utils.generateUUID();return i&&(this.callbacks[n]=i),r.bind(this)({uuid:n,op:t.OP_USERS,topic:e}),n}},e.topics=function(e){if(this.isConnected()){var i=t.Utils.generateUUID();e&&(this.callbacks[i]=e);var n={uuid:i,op:t.OP_TOPICS};return r.bind(this)(n),i}},this.Xserv=t}.call(this),function(){Xserv.Utils={format:function(t,e){var i=t;for(var n in e)i=i.replace(new RegExp("\\"+n,"g"),e[n]);return i},isFunction:function(t){return"function"===$.type(t)},isString:function(t){return"string"===$.type(t)},isObject:function(t){return"object"===$.type(t)},isArray:function(t){return"array"===$.type(t)},generateUUID:function(){var t=(new Date).getTime(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:3&i|8).toString(16)});return e},getTimeZoneData:function(){var t=new Date,e=new Date(t.getFullYear(),0,1),i=new Date(t.getFullYear(),6,1),n=t.getTimezoneOffset()<Math.max(e.getTimezoneOffset(),i.getTimezoneOffset());return{tz_offset:-1*parseInt(t.getTimezoneOffset()/60),tz_dst:+n}},getBrowser:function(){var t,e,i,n=navigator.userAgent,r=navigator.appName,s=""+parseFloat(navigator.appVersion);-1!=(e=n.indexOf("Opera"))?(r="Opera",s=n.substring(e+6),-1!=(e=n.indexOf("Version"))&&(s=n.substring(e+8))):-1!=(e=n.indexOf("MSIE"))?(r="Microsoft Internet Explorer",s=n.substring(e+5)):-1!=(e=n.indexOf("Chrome"))?(r="Chrome",s=n.substring(e+7)):-1!=(e=n.indexOf("Safari"))?(r="Safari",s=n.substring(e+7),-1!=(e=n.indexOf("Version"))&&(s=n.substring(e+8))):-1!=(e=n.indexOf("Firefox"))?(r="Firefox",s=n.substring(e+8)):(t=n.lastIndexOf(" ")+1)<(e=n.lastIndexOf("/"))&&(r=n.substring(t,e),s=n.substring(e+1),r.toLowerCase()==r.toUpperCase()&&(r=navigator.appName)),-1!=(i=s.indexOf(";"))&&(s=s.substring(0,i)),-1!=(i=s.indexOf(" "))&&(s=s.substring(0,i));var o=parseInt(""+s,10);return isNaN(o)&&(s=""+parseFloat(navigator.appVersion)),r+" "+s}}}.call(this),function(){var t={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var i,n,r,s,o,a,c,h="",u=0;for(e=t._utf8_encode(e);u<e.length;)i=e.charCodeAt(u++),n=e.charCodeAt(u++),r=e.charCodeAt(u++),s=i>>2,o=(3&i)<<4|n>>4,a=(15&n)<<2|r>>6,c=63&r,isNaN(n)?a=c=64:isNaN(r)&&(c=64),h=h+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(a)+this._keyStr.charAt(c);return h},decode:function(e){var i,n,r,s,o,a,c,h="",u=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<e.length;)s=this._keyStr.indexOf(e.charAt(u++)),o=this._keyStr.indexOf(e.charAt(u++)),a=this._keyStr.indexOf(e.charAt(u++)),c=this._keyStr.indexOf(e.charAt(u++)),i=s<<2|o>>4,n=(15&o)<<4|a>>2,r=(3&a)<<6|c,h+=String.fromCharCode(i),64!=a&&(h+=String.fromCharCode(n)),64!=c&&(h+=String.fromCharCode(r));return h=t._utf8_decode(h)},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var e="",i=0;i<t.length;i++){var n=t.charCodeAt(i);128>n?e+=String.fromCharCode(n):n>127&&2048>n?(e+=String.fromCharCode(n>>6|192),e+=String.fromCharCode(63&n|128)):(e+=String.fromCharCode(n>>12|224),e+=String.fromCharCode(n>>6&63|128),e+=String.fromCharCode(63&n|128))}return e},_utf8_decode:function(t){for(var e="",i=0,n=c1=c2=0;i<t.length;)n=t.charCodeAt(i),128>n?(e+=String.fromCharCode(n),i++):n>191&&224>n?(c2=t.charCodeAt(i+1),e+=String.fromCharCode((31&n)<<6|63&c2),i+=2):(c2=t.charCodeAt(i+1),c3=t.charCodeAt(i+2),e+=String.fromCharCode((15&n)<<12|(63&c2)<<6|63&c3),i+=3);return e}};Xserv.Utils.Base64=t}.call(this),function(){Xserv.VERSION="1",Xserv.HOST="mobile-italia.com",Xserv.PORT="4332",Xserv.TLS_PORT="8332",Xserv.WS_URL="ws$1://$2:$3/ws/$4?version=$5",Xserv.DEFAULT_AUTH_URL="http$1://$2:$3/1/user",Xserv.DEFAULT_RI=5e3,Xserv.OP_HANDSHAKE=100,Xserv.OP_PUBLISH=200,Xserv.OP_SUBSCRIBE=201,Xserv.OP_UNSUBSCRIBE=202,Xserv.OP_HISTORY=203,Xserv.OP_USERS=204,Xserv.OP_TOPICS=205,Xserv.OP_UPDATE=300,Xserv.OP_UPDATE_ALL=301,Xserv.OP_DELETE=302,Xserv.OP_DELETE_ALL=303,Xserv.OP_JOIN=401,Xserv.OP_LEAVE=402,Xserv.RC_OK=1,Xserv.RC_GENERIC_ERROR=0,Xserv.RC_ARGS_ERROR=-1,Xserv.RC_ALREADY_SUBSCRIBED=-2,Xserv.RC_UNAUTHORIZED=-3,Xserv.RC_NO_TOPIC=-4,Xserv.RC_NO_DATA=-5,Xserv.RC_NOT_PRIVATE=-6,Xserv.RC_LIMIT_MESSAGES=-7,Xserv.RC_DB_ERROR=-8}.call(this),Xserv});