!function(e,t){"function"==typeof define&&define.amd?define([],function(){return e.Xserv=t()}):"object"==typeof exports?module.exports=t():e.Xserv=t()}(this,function(){return function(){function e(t){this.app_id=t,this.conn=null,this.listeners=[],this.user_data={},this.reconnect_interval=e.DEFAULT_RI,this.instanceUUID=e.Utils.generateUUID(),this.is_auto_reconnect=!1}var t=e.prototype,n=function(){setTimeout(function(){this.connect(!0)}.bind(this),this.reconnect_interval)},i=function(){var t=e.Utils.getBrowser(),n=e.Utils.getTimeZoneData(),i=t||"",r="Browser";i.length>45&&(i=i.substring(0,45)),r.length>45&&(r=r.substring(0,45));var s=navigator.language||navigator.userLanguage,o={uuid:this.instanceUUID,model:i,os:r,tz_offset:n.tz_offset,tz_dst:n.tz_dst,lang:s};this.conn.send(JSON.stringify(o))},r=function(t){if(this.isConnected())if(t.op==e.BIND&&e.isPrivateTopic(t.topic)&&t.auth_endpoint){var n=t.auth_endpoint.endpoint||e.Utils.format(e.DEFAULT_AUTH_URL,{$1:e.ADDRESS,$2:e.PORT,$3:this.app_id}),i=t.auth_endpoint.user||"",r=t.auth_endpoint.pass||"",s={topic:t.topic,user:i,pass:r};$.ajax({cache:!1,crossDomain:!0,type:"post",url:n,contentType:"application/json; charset=UTF-8",data:JSON.stringify(s),processData:!1,dataType:"json"}).always(function(e){var n=$.extend({},t);delete n.auth_endpoint,e&&(n.arg1=s.user,n.arg2=e.data,n.arg3=e.sign),this.conn.send(JSON.stringify(n))}.bind(this))}else this.conn.send(JSON.stringify(t))},s=function(e){this.user_data=e},o=function(t){return t==e.BIND?"bind":t==e.UNBIND?"unbind":t==e.HISTORY?"history":t==e.PRESENCE?"presence":t==e.PRESENCE_IN?"presence_in":t==e.PRESENCE_OUT?"presence_out":t==e.TRIGGER?"trigger":void 0};e.isPrivateTopic=function(e){return"@"==e.charAt(0)},t.isConnected=function(){return this.conn&&this.conn.readyState==WebSocket.OPEN},t.connect=function(t){if(t||(this.is_auto_reconnect=!0),!this.isConnected()){if(window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),this.conn){for(var r in this.listeners)this.conn.removeEventListener(this.listeners[r].event,this.listeners[r].callback);delete this.conn}this.conn=new WebSocket(e.Utils.format(e.URL,{$1:e.ADDRESS,$2:e.PORT,$3:this.app_id}));for(var r in this.listeners)this.conn.addEventListener(this.listeners[r].event,this.listeners[r].callback);this.conn.onopen=function(e){i.bind(this)()}.bind(this),this.conn.onclose=function(e){this.is_auto_reconnect&&n.bind(this)()}.bind(this)}},t.disconnect=function(){this.is_auto_reconnect=!1,this.isConnected()&&this.conn.close()},t.addEventListener=function(t,n){if("receive_events"==t){var i=function(e){var t=JSON.parse(e.data);if(t.message){try{t.message=JSON.parse(t.message)}catch(i){}n(t)}}.bind(this);this.listeners.push({event:"message",callback:i})}else if("receive_ops_response"==t){var i=function(t){var i=JSON.parse(t.data);if(i.op){i.name=o(i.op);try{var r=e.Utils.Base64.decode(i.data);r=JSON.parse(r),i.data=r,i.op==e.BIND&&e.isPrivateTopic(i.topic)&&i.rc==e.RC_OK&&e.Utils.isObject(i.data)&&s.bind(this)(i.data)}catch(a){}n(i)}}.bind(this);this.listeners.push({event:"message",callback:i})}else"open_connection"==t?this.listeners.push({event:"open",callback:n}):"close_connection"==t?this.listeners.push({event:"close",callback:n}):"error_connection"==t&&this.listeners.push({event:"error",callback:n})},t.setReconnectInterval=function(e){this.reconnect_interval=e},t.getReconnectInterval=function(){return this.reconnect_interval},t.getUserData=function(){return this.user_data},t.trigger=function(t,n,i){if(this.isConnected()){var s=e.Utils.generateUUID();return!e.Utils.isString(i)&&e.Utils.isObject(i)&&(i=JSON.stringify(i)),r.bind(this)({uuid:s,op:e.TRIGGER,topic:t,event:n,arg1:i}),s}},t.bind=function(t,n,i){if(this.isConnected()){var s=e.Utils.generateUUID(),o={uuid:s,op:e.BIND,topic:t,event:n};return i&&(o.auth_endpoint=i),r.bind(this)(o),s}},t.unbind=function(t,n){if(this.isConnected()){var i=e.Utils.generateUUID();return n=n||"",r.bind(this)({uuid:i,op:e.UNBIND,topic:t,event:n}),i}},t.historyById=function(t,n,i,s){if(this.isConnected()){var o=e.Utils.generateUUID();return r.bind(this)({uuid:o,op:e.HISTORY,topic:t,event:n,arg1:e.HISTORY_ID,arg2:String(i),arg3:String(s)}),o}},t.historyByTimestamp=function(t,n,i,s){if(this.isConnected()){var o=e.Utils.generateUUID();return r.bind(this)({uuid:o,op:e.HISTORY,topic:t,event:n,arg1:e.HISTORY_TIMESTAMP,arg2:String(i),arg3:String(s)}),o}},t.presence=function(t,n){if(this.isConnected()){var i=e.Utils.generateUUID();return r.bind(this)({uuid:i,op:e.PRESENCE,topic:t,event:n}),i}},this.Xserv=e}.call(this),function(){Xserv.Utils={format:function(e,t){var n=e;for(var i in t)n=n.replace(new RegExp("\\"+i,"g"),t[i]);return n},isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},generateUUID:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:3&n|8).toString(16)});return t},getTimeZoneData:function(){var e=new Date,t=new Date(e.getFullYear(),0,1),n=new Date(e.getFullYear(),6,1),i=e.getTimezoneOffset()<Math.max(t.getTimezoneOffset(),n.getTimezoneOffset());return{tz_offset:-1*parseInt(e.getTimezoneOffset()/60),tz_dst:+i}},getBrowser:function(){var e,t,n,i=navigator.userAgent,r=navigator.appName,s=""+parseFloat(navigator.appVersion);-1!=(t=i.indexOf("Opera"))?(r="Opera",s=i.substring(t+6),-1!=(t=i.indexOf("Version"))&&(s=i.substring(t+8))):-1!=(t=i.indexOf("MSIE"))?(r="Microsoft Internet Explorer",s=i.substring(t+5)):-1!=(t=i.indexOf("Chrome"))?(r="Chrome",s=i.substring(t+7)):-1!=(t=i.indexOf("Safari"))?(r="Safari",s=i.substring(t+7),-1!=(t=i.indexOf("Version"))&&(s=i.substring(t+8))):-1!=(t=i.indexOf("Firefox"))?(r="Firefox",s=i.substring(t+8)):(e=i.lastIndexOf(" ")+1)<(t=i.lastIndexOf("/"))&&(r=i.substring(e,t),s=i.substring(t+1),r.toLowerCase()==r.toUpperCase()&&(r=navigator.appName)),-1!=(n=s.indexOf(";"))&&(s=s.substring(0,n)),-1!=(n=s.indexOf(" "))&&(s=s.substring(0,n));var o=parseInt(""+s,10);return isNaN(o)&&(s=""+parseFloat(navigator.appVersion)),r+" "+s}}}.call(this),function(){var e={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){var n,i,r,s,o,a,c,h="",u=0;for(t=e._utf8_encode(t);u<t.length;)n=t.charCodeAt(u++),i=t.charCodeAt(u++),r=t.charCodeAt(u++),s=n>>2,o=(3&n)<<4|i>>4,a=(15&i)<<2|r>>6,c=63&r,isNaN(i)?a=c=64:isNaN(r)&&(c=64),h=h+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(a)+this._keyStr.charAt(c);return h},decode:function(t){var n,i,r,s,o,a,c,h="",u=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<t.length;)s=this._keyStr.indexOf(t.charAt(u++)),o=this._keyStr.indexOf(t.charAt(u++)),a=this._keyStr.indexOf(t.charAt(u++)),c=this._keyStr.indexOf(t.charAt(u++)),n=s<<2|o>>4,i=(15&o)<<4|a>>2,r=(3&a)<<6|c,h+=String.fromCharCode(n),64!=a&&(h+=String.fromCharCode(i)),64!=c&&(h+=String.fromCharCode(r));return h=e._utf8_decode(h)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",n=0;n<e.length;n++){var i=e.charCodeAt(n);128>i?t+=String.fromCharCode(i):i>127&&2048>i?(t+=String.fromCharCode(i>>6|192),t+=String.fromCharCode(63&i|128)):(t+=String.fromCharCode(i>>12|224),t+=String.fromCharCode(i>>6&63|128),t+=String.fromCharCode(63&i|128))}return t},_utf8_decode:function(e){for(var t="",n=0,i=c1=c2=0;n<e.length;)i=e.charCodeAt(n),128>i?(t+=String.fromCharCode(i),n++):i>191&&224>i?(c2=e.charCodeAt(n+1),t+=String.fromCharCode((31&i)<<6|63&c2),n+=2):(c2=e.charCodeAt(n+1),c3=e.charCodeAt(n+2),t+=String.fromCharCode((15&i)<<12|(63&c2)<<6|63&c3),n+=3);return t}};Xserv.Utils.Base64=e}.call(this),function(){Xserv.VERSION="1.0.0",Xserv.ADDRESS="xserv.mobile-italia.com",Xserv.PORT="4332",Xserv.URL="ws://$1:$2/ws/$3",Xserv.DEFAULT_AUTH_URL="http://$1:$2/app/$3/auth_user",Xserv.DEFAULT_RI=5e3,Xserv.TRIGGER=200,Xserv.BIND=201,Xserv.UNBIND=202,Xserv.HISTORY=203,Xserv.PRESENCE=204,Xserv.PRESENCE_IN=Xserv.BIND+200,Xserv.PRESENCE_OUT=Xserv.UNBIND+200,Xserv.HISTORY_ID="id",Xserv.HISTORY_TIMESTAMP="timestamp",Xserv.RC_OK=1,Xserv.RC_GENERIC_ERROR=0,Xserv.RC_ARGS_ERROR=-1,Xserv.RC_ALREADY_BINDED=-2,Xserv.RC_UNAUTHORIZED=-3,Xserv.RC_NO_EVENT=-4,Xserv.RC_NO_DATA=-5,Xserv.RC_NOT_PRIVATE=-6}.call(this),Xserv});